{:require
 [[com.yakread.lib.test :as t]
  [clojure.data.generators :as gen]
  [com.yakread.work.account :refer :all]],
 :tests
 [{:eval (export-user-data {:biff/job {:user/id "abc123"}} :start),
   :result
   {:biff.fx/pathom
    {:entity {:user/id "abc123"},
     :query
     [:user/id
      :user/email
      :user/timezone
      :user.export/feed-subs
      :user.export/bookmarks
      :user.export/favorites]},
    :biff.fx/temp-dir {},
    :biff.fx/next :upload}}
  _
  {:eval
   (export-user-data
    {:biff/now (t/instant 2000),
     :biff.fx/pathom
     {:user/id "abc123",
      :user/email "hello@example.com",
      :user/timezone "America/Denver",
      :user.export/feed-subs "feed-subs",
      :user.export/bookmarks "bookmarks",
      :user.export/favorites "favorites"},
     :biff.fx/temp-dir "/tmp/dir"}
    :upload),
   :result
   [{:biff.fx/write
     ({:file
       #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123/feed-subscriptions.opml",
       :content "feed-subs"}
      {:file
       #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123/bookmarks.csv",
       :content "bookmarks"}
      {:file
       #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123/favorites.csv",
       :content "favorites"})}
    {:biff.fx/shell
     ["zip"
      "-r"
      "yakread-export-1999-12-31-946684800000-abc123.zip"
      "yakread-export-1999-12-31-946684800000-abc123"
      :dir
      "/tmp/dir"]}
    {:biff.fx/delete-files
     #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123"}
    {:biff.fx/s3
     {:config-ns yakread.s3.export,
      :key "yakread-export-1999-12-31-946684800000-abc123.zip",
      :method "PUT",
      :body
      #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123.zip",
      :headers
      {"x-amz-acl" "private", "content-type" "application/zip"}}}
    {:biff.fx/delete-files
     "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123.zip"}
    {:biff.fx/s3-presigned-url
     {:config-ns yakread.s3.export,
      :key "yakread-export-1999-12-31-946684800000-abc123.zip",
      :method "GET",
      :expires-at #time/instant "2000-01-08T00:00:00Z"}}
    {:biff.fx/next :send,
     :com.yakread.work.account/email "hello@example.com"}]}
  _
  {:eval
   (export-user-data
    {:biff.fx/s3-presigned-url "example.com",
     :com.yakread.work.account/email "hello@example.com"}
    :send),
   :result
   {:biff.fx/email
    {:template :export,
     :to "hello@example.com",
     :download-url "example.com"}}}
  _
  {:doc "delete-account: start fetches user data via pathom"
   :eval (delete-account {:biff/job {:user/id "user123"}} :start)}
  _
  {:doc "delete-account: delete with user customer-id and ad customer-id"
   :eval
   (delete-account
    {:biff.fx/pathom
     {:user/id "user123"
      :user/customer-id "cus_user123"
      :user/email-username "testuser"
      :user/subscriptions [{:xt/id "sub1" :sub.feed/feed "feed1"}
                           {:xt/id "sub2" :sub.feed/feed "feed2"}]
      :user/ad {:xt/id "ad1" :ad/customer-id "cus_ad123"}}
     :biff/secret (fn [k] (when (= k :stripe/api-key) "sk_test_123"))}
    :delete)}
  _
  {:doc "delete-account: delete without customer-ids or ad"
   :eval
   (delete-account
    {:biff.fx/pathom
     {:user/id "user123"
      :user/subscriptions []}
     :biff/secret (fn [k] nil)}
    :delete)}
  _
  {:doc "delete-account: delete with email-username records hash"
   :eval
   (delete-account
    {:biff.fx/pathom
     {:user/id "user123"
      :user/email-username "testuser@example.com"
      :user/subscriptions []}
     :biff/secret (fn [k] nil)}
    :delete)}
  _
  {:doc "delete-account: delete-email-batch with no email-ids returns nil"
   :eval
   (t/with-node
    [node {}]
    (delete-account
     {:biff/conn node
      :biff/job {:user/id "user123"}
      :session {:uid "user123"}
      :com.yakread.work.account/email-ids []}
     :delete-email-batch))}
  _
  {:doc "delete-account: delete-email-batch processes batch of emails"
   :eval
   (t/with-node
    [node
     {:item [{:xt/id "item1"
              :item/content-key #uuid "00000000-0000-0000-0000-000000000001"
              :item.email/raw-content-key #uuid "00000000-0000-0000-0000-000000000002"}
             {:xt/id "item2"
              :item/content-key #uuid "00000000-0000-0000-0000-000000000003"}
             {:xt/id "item3"
              :item.email/raw-content-key #uuid "00000000-0000-0000-0000-000000000004"}]}]
    (delete-account
     {:biff/conn node
      :biff/job {:user/id "user123"}
      :session {:uid "user123"}
      :com.yakread.work.account/email-ids ["item1" "item2" "item3"]}
     :delete-email-batch))}
  _
  {:doc "delete-account: delete-email-batch with more than 500 items continues to next batch"
   :eval
   (t/with-node
    [node
     {:item [{:xt/id "item1"
              :item/content-key #uuid "00000000-0000-0000-0000-000000000001"}]}]
    (let [email-ids (into ["item1"] (map #(str "item" %) (range 2 502)))]
      (delete-account
       {:biff/conn node
        :biff/job {:user/id "user123"}
        :session {:uid "user123"}
        :com.yakread.work.account/email-ids email-ids}
       :delete-email-batch)))}
  _]}
