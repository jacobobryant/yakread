{:require
 [[com.yakread.lib.test :as t]
  [clojure.data.generators :as gen]
  [com.yakread.work.account :refer :all]],
 :tests
 [{:eval (export-user-data {:biff/job {:user/id "abc123"}} :start),
   :result
   {:biff.fx/pathom
    {:entity {:user/id "abc123"},
     :query
     [:user/id
      :user/email
      :user/timezone
      :user.export/feed-subs
      :user.export/bookmarks
      :user.export/favorites]},
    :biff.fx/temp-dir {},
    :biff.fx/next :upload}}
  _
  {:eval
   (export-user-data
    {:biff/now (t/instant 2000),
     :biff.fx/pathom
     {:user/id "abc123",
      :user/email "hello@example.com",
      :user/timezone "America/Denver",
      :user.export/feed-subs "feed-subs",
      :user.export/bookmarks "bookmarks",
      :user.export/favorites "favorites"},
     :biff.fx/temp-dir "/tmp/dir"}
    :upload),
   :result
   [{:biff.fx/write
     ({:file
       #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123/feed-subscriptions.opml",
       :content "feed-subs"}
      {:file
       #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123/bookmarks.csv",
       :content "bookmarks"}
      {:file
       #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123/favorites.csv",
       :content "favorites"})}
    {:biff.fx/shell
     ["zip"
      "-r"
      "yakread-export-1999-12-31-946684800000-abc123.zip"
      "yakread-export-1999-12-31-946684800000-abc123"
      :dir
      "/tmp/dir"]}
    {:biff.fx/delete-files
     #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123"}
    {:biff.fx/s3
     {:config-ns yakread.s3.export,
      :key "yakread-export-1999-12-31-946684800000-abc123.zip",
      :method "PUT",
      :body
      #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123.zip",
      :headers
      {"x-amz-acl" "private", "content-type" "application/zip"}}}
    {:biff.fx/delete-files
     "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123.zip"}
    {:biff.fx/s3-presigned-url
     {:config-ns yakread.s3.export,
      :key "yakread-export-1999-12-31-946684800000-abc123.zip",
      :method "GET",
      :expires-at #time/instant "2000-01-08T00:00:00Z"}}
    {:biff.fx/next :send,
     :com.yakread.work.account/email "hello@example.com"}]}
  _
  {:eval
   (export-user-data
    {:biff.fx/s3-presigned-url "example.com",
     :com.yakread.work.account/email "hello@example.com"}
    :send),
   :result
   {:biff.fx/email
    {:template :export,
     :to "hello@example.com",
     :download-url "example.com"}}}
  _
  {:doc "delete-account: start state queries user data",
   :eval (delete-account {:biff/job {:user/id "user123"}} :start),
   :result
   {:biff.fx/pathom
    {:entity {:user/id "user123"},
     :query
     [:user/id
      (:user/email-username
       {:com.wsscode.pathom3.connect.operation/optional? true})
      {(:user/subscriptions
        {:com.wsscode.pathom3.connect.operation/optional? true})
       [:xt/id
        (:sub.feed/feed
         {:com.wsscode.pathom3.connect.operation/optional? true})]}
      {(:user/ad
        {:com.wsscode.pathom3.connect.operation/optional? true})
       [:xt/id
        (:ad/customer-id
         {:com.wsscode.pathom3.connect.operation/optional? true})]}
      (:user/customer-id
       {:com.wsscode.pathom3.connect.operation/optional? true})]},
    :biff.fx/next :delete}}
  _
  {:doc "delete-account: delete state with user and ad customer ids",
   :eval
   (delete-account
    {:biff.fx/pathom
     {:user/id "user123",
      :user/customer-id "cus_user123",
      :user/subscriptions
      [{:xt/id "sub1", :sub.feed/feed "feed1"}
       {:xt/id "sub2", :sub.feed/feed nil}],
      :user/ad {:xt/id "ad1", :ad/customer-id "cus_ad123"},
      :user/email-username "user@example.com"},
     :biff/secret (fn [k] (when (= k :stripe/api-key) "sk_test_123"))}
    :delete),
   :result
   [{:biff.fx/http
     ({:method :delete,
       :url "https://api.stripe.com/v1/customers/cus_user123",
       :basic-auth ["sk_test_123"],
       :socket-timeout 10000,
       :connection-timeout 10000}
      {:method :delete,
       :url "https://api.stripe.com/v1/customers/cus_ad123",
       :basic-auth ["sk_test_123"],
       :socket-timeout 10000,
       :connection-timeout 10000})}
    {:biff.fx/tx
     ([:erase-docs :user "user123"]
      [:erase-docs :ad "ad1"]
      [:delete-docs :sub "sub1"]
      [:put-docs
       :deleted-user
       {:xt/id #uuid "bb20b45f-d4d9-5138-3d93-cb799b3970be",
        :deleted-user/email-username-hash
        "b4c9a289323b21a01c3e940f150eb9b8c542587f1abfd8f0e1cc1ffc5e475514"}]),
     :biff.fx/next :delete-email-batch}]}
  _
  {:doc "delete-account: delete state with only user customer id",
   :eval
   (delete-account
    {:biff.fx/pathom
     {:user/id "user123",
      :user/customer-id "cus_user123",
      :user/subscriptions [],
      :user/ad nil,
      :user/email-username nil},
     :biff/secret (fn [k] (when (= k :stripe/api-key) "sk_test_123"))}
    :delete),
   :result
   [{:biff.fx/http
     ({:method :delete,
       :url "https://api.stripe.com/v1/customers/cus_user123",
       :basic-auth ["sk_test_123"],
       :socket-timeout 10000,
       :connection-timeout 10000})}
    {:biff.fx/tx ([:erase-docs :user "user123"]),
     :biff.fx/next :delete-email-batch}]}
  _
  {:doc "delete-account: delete state with no customer ids",
   :eval
   (delete-account
    {:biff.fx/pathom
     {:user/id "user123",
      :user/customer-id nil,
      :user/subscriptions [],
      :user/ad nil,
      :user/email-username nil},
     :biff/secret (fn [k] nil)}
    :delete),
   :result
   [{:biff.fx/http ()}
    {:biff.fx/tx ([:erase-docs :user "user123"]),
     :biff.fx/next :delete-email-batch}]}
  _
  {:doc "delete-account: delete-email-batch with no emails",
   :eval
   (delete-account
    {:biff/conn nil,
     :biff/job {:user/id "user123"},
     :session {:uid "user123"},
     :com.yakread.work.account/email-ids []}
    :delete-email-batch),
   :result nil}
  _
  {:doc "delete-account: delete-email-batch with email items",
   :eval
   (t/with-node
    [node
     {:item
      [{:xt/id (t/uuid 2),
        :item/content-key "content-key-1",
        :item.email/raw-content-key "raw-key-1"}
       {:xt/id (t/uuid 3), :item/content-key "content-key-2"}]}]
    (delete-account
     {:biff/conn node,
      :biff/job {:user/id (t/uuid 10)},
      :session {:uid (t/uuid 10)},
      :com.yakread.work.account/email-ids [(t/uuid 2) (t/uuid 3)]}
     :delete-email-batch)),
   :result
   [{:biff.fx/s3
     ({:key "content-key-1",
       :config-ns yakread.s3.content,
       :method "DELETE"}
      {:key "raw-key-1",
       :config-ns yakread.s3.emails,
       :method "DELETE"}
      {:key "content-key-2",
       :config-ns yakread.s3.content,
       :method "DELETE"})}
    {:biff.fx/tx
     [[:erase-docs
       :item
       #uuid "00020000-0000-0000-0000-000000000002"
       #uuid "00030000-0000-0000-0000-000000000003"]]}
    {:biff.fx/next :delete-email-batch,
     :com.yakread.work.account/email-ids ()}]}
  _]}
