{:require
 [[com.yakread.lib.test :as t]
  [clojure.data.generators :as gen]
  [com.yakread.work.account :refer :all]],
 :tests
 [{:eval (export-user-data {:biff/job {:user/id "abc123"}} :start),
   :result
   {:biff.fx/pathom
    {:entity {:user/id "abc123"},
     :query
     [:user/id
      :user/email
      :user/timezone
      :user.export/feed-subs
      :user.export/bookmarks
      :user.export/favorites]},
    :biff.fx/temp-dir {},
    :biff.fx/next :upload}}
  _
  {:eval
   (export-user-data
    {:biff/now (t/instant 2000),
     :biff.fx/pathom
     {:user/id "abc123",
      :user/email "hello@example.com",
      :user/timezone "America/Denver",
      :user.export/feed-subs "feed-subs",
      :user.export/bookmarks "bookmarks",
      :user.export/favorites "favorites"},
     :biff.fx/temp-dir "/tmp/dir"}
    :upload),
   :result
   [{:biff.fx/write
     ({:file
       #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123/feed-subscriptions.opml",
       :content "feed-subs"}
      {:file
       #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123/bookmarks.csv",
       :content "bookmarks"}
      {:file
       #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123/favorites.csv",
       :content "favorites"})}
    {:biff.fx/shell
     ["zip"
      "-r"
      "yakread-export-1999-12-31-946684800000-abc123.zip"
      "yakread-export-1999-12-31-946684800000-abc123"
      :dir
      "/tmp/dir"]}
    {:biff.fx/delete-files
     #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123"}
    {:biff.fx/s3
     {:config-ns yakread.s3.export,
      :key "yakread-export-1999-12-31-946684800000-abc123.zip",
      :method "PUT",
      :body
      #biff/file "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123.zip",
      :headers
      {"x-amz-acl" "private", "content-type" "application/zip"}}}
    {:biff.fx/delete-files
     "/tmp/dir/yakread-export-1999-12-31-946684800000-abc123.zip"}
    {:biff.fx/s3-presigned-url
     {:config-ns yakread.s3.export,
      :key "yakread-export-1999-12-31-946684800000-abc123.zip",
      :method "GET",
      :expires-at #time/instant "2000-01-08T00:00:00Z"}}
    {:biff.fx/next :send,
     :com.yakread.work.account/email "hello@example.com"}]}
  _
  {:eval
   (export-user-data
    {:biff.fx/s3-presigned-url "example.com",
     :com.yakread.work.account/email "hello@example.com"}
    :send),
   :result
   {:biff.fx/email
    {:template :export,
     :to "hello@example.com",
     :download-url "example.com"}}}
  _]}
