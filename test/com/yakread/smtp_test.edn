{:require
 [[com.yakread.lib.test :as t]
  [com.yakread.lib.smtp :as lib.smtp]
  [clojure.java.io :as io]
  [clojure.data.generators :as gen]
  [com.yakread.smtp :refer :all]],
 :fixtures
 {message
  (lib.smtp/deliver-opts
   "bob@example.com"
   (slurp (io/resource "com/yakread/smtp/raw-email.txt"))),
  html
  "<!DOCTYPE html><html><head><title></title></head><body><div>the quick brown fox jumps over the lazy dog</div></body></html>"},
 :tests
 [{:doc "deliver* invalid domain",
   :eval
   (t/with-node
    [node {:user [{:xt/id "user1", :user/email-username "hello"}]}]
    (let
     [f
      (fn
       [message-overrides]
       (deliver*
        {:biff/conn node,
         :yakread/domain "example.com",
         :biff.smtp/message (merge message message-overrides)}
        :start))]
     {:invalid-domain (f {:domain "1.example.com", :username "hello"}),
      :invalid-username (f {:domain "example.com", :username "hi"}),
      :valid (f {:username "hello"})})),
   :result
   {:invalid-domain nil,
    :invalid-username nil,
    :valid
    {:com.yakread.fx/js
     {:fn-name "juice",
      :input
      {:html
       "<!DOCTYPE html><html><head><title></title></head><body><div>the quick brown fox jumps over the lazy dog</div></body></html>"}},
     :biff.fx/next :end,
     :com.yakread.smtp/url "https://example.com/p/example-post"}}}
  _
  {:doc "deliver* :end parse failed",
   :eval
   (deliver*
    {:biff.smtp/message {:username "hello"}, :biff/now (t/zdt 2000)}
    :end),
   :result
   {:biff.fx/spit
    {:file "storage/juice-failed/946684800000.edn",
     :content "{:username \"hello\"}"}}}
  _
  {:doc "deliver* :end existing sub",
   :eval
   (t/with-node
    [node
     {:user [{:xt/id (t/uuid 0), :user/email-username "bob"}],
      :sub
      [{:xt/id (t/uuid 1),
        :sub.email/from "alice@example.com",
        :sub/user (t/uuid 0)}]}]
    (deliver*
     {:biff.smtp/message message,
      :biff/conn node,
      :biff/now (t/zdt 2000),
      :com.yakread.smtp/url "https://example.com/p/example-post",
      :com.yakread.fx/js {:html html}}
     :end)),
   :result
   [{:biff.fx/s3
     [{:config-ns yakread.s3.emails,
       :key #uuid "bb20b45f-d4d9-5138-3d93-cb799b3970be",
       :method "PUT",
       :body
       "MIME-Version: 1.0\nX-PersonalityId: 150084168\nDate: Sun, 04 Jan 2026 05:24:51 -0700\nFrom: \"Alice\" <alice@example.com>\nTo: \"Bob\" <bob@example.com>\nMessage-Id: <b118cd9b-36e3-4d66-997f-2ca18932cb67@app.fastmail.com>\nSubject: subject line\nList-Post: <https://example.com/p/example-post>\nContent-Type: multipart/alternative;\n boundary=3c5e59a5f6894d32b3773fdf5e1b9994\n\n--3c5e59a5f6894d32b3773fdf5e1b9994\nContent-Type: text/plain\nContent-Transfer-Encoding: 7bit\n\nthe quick brown fox jumps over the lazy dog\n--3c5e59a5f6894d32b3773fdf5e1b9994\nContent-Type: text/html\nContent-Transfer-Encoding: 7bit\n\n<!DOCTYPE html><html><head><title></title></head><body><div>the quick brown fox jumps over the lazy dog</div></body></html>\n--3c5e59a5f6894d32b3773fdf5e1b9994--\n\n",
       :headers {"x-amz-acl" "private", "content-type" "text/plain"}}
      {:config-ns yakread.s3.content,
       :key #uuid "a32dc9f6-4f1d-f03a-8ce9-70b71df42503",
       :method "PUT",
       :body
       "<!doctype html>\n<html>\n <head>\n  <title></title>\n </head>\n <body>\n  <div>\n   the quick brown fox jumps over the lazy dog\n  </div>\n </body>\n</html>",
       :headers {"x-amz-acl" "private", "content-type" "text/html"}}]}
    {:biff.fx/tx
     ([:put-docs
       :item
       {:item/excerpt "the quick brown fox jumps over the lazy dog",
        :item/published-at
        #time/zoned-date-time "2000-01-01T00:00Z[UTC]",
        :item.email/sub #uuid "00010000-0000-0000-0000-000000000001",
        :item/url "https://example.com/p/example-post",
        :item/length 43,
        :item/content-key #uuid "a32dc9f6-4f1d-f03a-8ce9-70b71df42503",
        :item/lang "en",
        :item/author-name "alice@example.com",
        :item.email/reply-to "alice@example.com",
        :xt/id #uuid "0001ba3d-c812-a76d-554d-cd2b40b5f04b",
        :item/title "subject line",
        :item/ingested-at
        #time/zoned-date-time "2000-01-01T00:00Z[UTC]",
        :item.email/raw-content-key
        #uuid "bb20b45f-d4d9-5138-3d93-cb799b3970be"}])}]}
  _
  {:doc "deliver* :end new sub",
   :eval
   (t/with-node
    [node {:user [{:xt/id (t/uuid 0), :user/email-username "bob"}]}]
    (deliver*
     {:biff.smtp/message message,
      :biff/conn node,
      :biff/now (t/zdt 2000),
      :com.yakread.smtp/url "https://example.com/p/example-post",
      :com.yakread.fx/js {:html html}}
     :end)),
   :result
   [{:biff.fx/s3
     [{:config-ns yakread.s3.emails,
       :key #uuid "bb20b45f-d4d9-5138-3d93-cb799b3970be",
       :method "PUT",
       :body
       "MIME-Version: 1.0\nX-PersonalityId: 150084168\nDate: Sun, 04 Jan 2026 05:24:51 -0700\nFrom: \"Alice\" <alice@example.com>\nTo: \"Bob\" <bob@example.com>\nMessage-Id: <b118cd9b-36e3-4d66-997f-2ca18932cb67@app.fastmail.com>\nSubject: subject line\nList-Post: <https://example.com/p/example-post>\nContent-Type: multipart/alternative;\n boundary=3c5e59a5f6894d32b3773fdf5e1b9994\n\n--3c5e59a5f6894d32b3773fdf5e1b9994\nContent-Type: text/plain\nContent-Transfer-Encoding: 7bit\n\nthe quick brown fox jumps over the lazy dog\n--3c5e59a5f6894d32b3773fdf5e1b9994\nContent-Type: text/html\nContent-Transfer-Encoding: 7bit\n\n<!DOCTYPE html><html><head><title></title></head><body><div>the quick brown fox jumps over the lazy dog</div></body></html>\n--3c5e59a5f6894d32b3773fdf5e1b9994--\n\n",
       :headers {"x-amz-acl" "private", "content-type" "text/plain"}}
      {:config-ns yakread.s3.content,
       :key #uuid "a32dc9f6-4f1d-f03a-8ce9-70b71df42503",
       :method "PUT",
       :body
       "<!doctype html>\n<html>\n <head>\n  <title></title>\n </head>\n <body>\n  <div>\n   the quick brown fox jumps over the lazy dog\n  </div>\n </body>\n</html>",
       :headers {"x-amz-acl" "private", "content-type" "text/html"}}]}
    {:biff.fx/tx
     ([:put-docs
       :item
       {:item/excerpt "the quick brown fox jumps over the lazy dog",
        :item/published-at
        #time/zoned-date-time "2000-01-01T00:00Z[UTC]",
        :item.email/sub #uuid "0000ba3d-c812-a76d-554d-cd2b40b5f04b",
        :item/url "https://example.com/p/example-post",
        :item/length 43,
        :item.email/maybe-confirmation true,
        :item/content-key #uuid "a32dc9f6-4f1d-f03a-8ce9-70b71df42503",
        :item/lang "en",
        :item/author-name "alice@example.com",
        :item.email/reply-to "alice@example.com",
        :xt/id #uuid "0000c222-9cef-e94d-fc1e-932efb9a0f58",
        :item/title "subject line",
        :item/ingested-at
        #time/zoned-date-time "2000-01-01T00:00Z[UTC]",
        :item.email/raw-content-key
        #uuid "bb20b45f-d4d9-5138-3d93-cb799b3970be"}]
      [:put-docs
       :sub
       {:xt/id #uuid "0000ba3d-c812-a76d-554d-cd2b40b5f04b",
        :sub/user #uuid "00000000-0000-0000-0000-000000000000",
        :sub.email/from "alice@example.com",
        :sub/created-at
        #time/zoned-date-time "2000-01-01T00:00Z[UTC]"}]
      ["ASSERT ? >= (SELECT COUNT(*) FROM sub WHERE (\"sub$user\" = ?) AND (\"sub$email$from\" = ?))"
       1
       #uuid "00000000-0000-0000-0000-000000000000"
       "alice@example.com"])}]}
  _]}
